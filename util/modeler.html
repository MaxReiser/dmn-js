<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>dmn-js dmn++ modeler</title>

  <link rel="stylesheet" href="../packages/dmn-js/dist/assets/diagram-js.css">
  <link rel="stylesheet" href="../packages/dmn-js/dist/assets/dmn-js-shared.css">
  <link rel="stylesheet" href="../packages/dmn-js/dist/assets/dmn-js-drd.css">
  <link rel="stylesheet" href="../packages/dmn-js/dist/assets/dmn-js-decision-table.css">
  <link rel="stylesheet" href="../packages/dmn-js/dist/assets/dmn-js-decision-table-controls.css">
  <link rel="stylesheet" href="../packages/dmn-js/dist/assets/dmn-js-literal-expression.css">
  <link rel="stylesheet" href="../packages/dmn-js/dist/assets/dmn-font/css/dmn.css">

  <!-- modeler distro -->
  <script src="../packages/dmn-js/dist/dmn-modeler.development.js">console.log('dmn-modeler.development.js')</script>

  <!-- needed for this example only -->
  <script src="https://unpkg.com/jquery@3.3.1/dist/jquery.js"></script>

  <style>
    #save-button {
      width: 31%;
      bottom: 50px;
      left: 100px;
      background: cadetblue;
      border: solid 1px #CCC;
      border-radius: 2px;
      padding: 8px;
      font-family: 'Arial', sans-serif;
      font-weight: bold;
      cursor: default;
      font-size: 14px;
      color: #444;
      margin-outside: 20px;
    }
    #dl-button {
      width: 60%;
      bottom: 50px;
      left: 600px;
      background: cadetblue;
      padding: 5px;
      border: solid 1px #CCC;
      border-radius: 2px;
      padding: 8px;
      font-family: 'Arial', sans-serif;
      font-weight: bold;
      cursor: default;
      font-size: 14px;
      color: #444;
      margin-outside: 20px;
    }
    #edit-button {
      width: 31%;
      bottom: 50px;
      left: 50px;
      background: cadetblue;
      border: solid 1px #CCC;
      border-radius: 2px;
      padding: 8px;
      font-family: 'Arial', sans-serif;
      font-weight: bold;
      cursor: default;
      font-size: 14px;
      color: #444;
      margin-outside: 20px;
    }
    #xml-editor {
      position: relative;
      width: 100%;
      height: 200px;
      border: 2px solid #ccc;
    }
    #buttons {
      width: 50%;
      border-radius: 2px;
      margin-top: 5%;
    }


  </style>
</head>
<body>
<script src="https://unpkg.com/codeflask@1.4.1/build/codeflask.min.js"></script>

<div class="test-container">
  <div class="editor-parent">
    <!--<div id="xml-editor"></div>-->
    <div class="editor-container"></div>
    <div class="editor-tabs"></div>
  </div>
</div>
<div id="buttons">
  <button id="save-button" href="#">Download DMN File</button>
  <button id="edit-button", href="#">XML</button>
  <form id="dl-button" href="#">Upload DMN file
    <input type="file" id="newDmn" accept=".dmn">
  </form>
</div>
<script>


  const diagramUrl = './demo.dmn';
  const CLASS_NAMES = {
    drd: 'dmn-icon-lasso-tool',
    decisionTable: 'dmn-icon-decision-table',
    literalExpression: 'dmn-icon-literal-expression',
    businessKnowledgeModel: 'dmn-icon-business-knowledge-model', // add BMK to tab view
  };

  const $container = $('.editor-container');
  const $tabs = $('.editor-tabs');

  // modeler instance
  const dmnModeler = new DmnJS({
    container: $container,
    position: 'relative',
    height: 500,
    width: '100%',
    borderStyle: 'solid',
    borderWidth: '1px',
    borderColor: '#ccc',
    keyboard: {
      bindTo: window
    }
  });

  $tabs.delegate('.tab', 'click', async function(e) {

    // get index of view from clicked tab
    const viewIdx = parseInt(this.getAttribute('data-id'), 10);

    // get view using index
    const view = dmnModeler.getViews()[viewIdx];

    // open view
    try {
      await dmnModeler.open(view);
    } catch (err) {
      console.error('error opening tab', err);
    }
  });

  dmnModeler.on('views.changed', function(event) {
    // get views from event
    const { views, activeView } = event;
    // clear tabs
    $tabs.empty();
    // create a new tab for each view
    views.forEach(function(v, idx) {
      const className = CLASS_NAMES[v.type];
      const tab = $(`
            <div class="tab ${ v === activeView ? 'active' : ''}" data-id="${idx}">
              <span class="${ className }"></span>
              ${v.element.name || v.element.id}
            </div>
          `);
      $tabs.append(tab);
    });
  });

/**
 * function that creates an editable textarea with the xml of the diagram
 * if save button is clicked the xml is fed back into the dmnModeler and the textarea is removed
 */
  async function editXML() {
    let $xmleditor = $('<div/>', {
      id: 'xml-editor',
      class: 'xml-editor',
      href: '#',
      css: {
        width: '100%',
        height: 500,
        border: 2,
        marginOutside: 20,
        marginBottom: 20,
        borderStyle: 'solid',
        borderWidth: '1px',
        borderColor: '#ccc',
      }
    });
    $tabs.append($xmleditor);
    const { xml } = await dmnModeler.saveXML({ format: true });
    const flask = new CodeFlask('#xml-editor', { language: 'xml', lineNumbers: true , tabSize: 5});
    let editedXml = xml;
    flask.updateCode(editedXml);
    let $fullscreen = $('<button/>', {
      id: 'fullscreen-button',
      class: 'button',
      href: '#',
      text: 'Fullscreen',
        css: {
            position: 'relative',
            bottom: 50,
            left: 400,
            background: 'white',
            padding: 5,
            border: 'solid 1px #CCC',
            borderRadius: 2,
            padding: 8,
            fontFamily: 'Arial',
            fontWeight: 'bold',
            cursor: 'default',
            fontSize: 14,
            color: '#444',
            marginOutside: 20,
        }
    });
    /*
    $('#buttons').append($fullscreen);
    $fullscreen.on('click', function() {
        // set xml-editor to fullscreen
        $fullscreen.text('Exit Fullscreen');
        $xmleditor.requestFullscreen();
        //$xmleditor.css('width', '100%');
        //$xmleditor.css('height', '100%');
        //exit fullscreen and resore dmnmodeler drd view
        $fullscreen.on('click', function() {
          // remove $fullscreen button
          $xmleditor.exitFullscreen()
          $xmleditor.css('width', '100%');
          $xmleditor.css('height', '350');
          $fullscreen.remove();
        });

    });

     */


    $('#save-button').text('Discard');
    $('#save-button').off('click');
    $('#save-button').on('click', async function() {
      $('#edit-button').text('XML');
      $('#edit-button').off('click');
      $('#edit-button').on('click', editXML);

      $('#save-button').text('Download DMN File');
      $('#save-button').off('click');
      $('#save-button').on('click', exportDiagram);
      $('#xml-editor').remove()
      return
    });

    $('#edit-button').text('Save');
    $('#edit-button').off('click');
    $('#edit-button').on('click', async function() {
      editedXml = flask.getCode();
      try {
        //load the edited xml into the modeler
        const { warnings } = await dmnModeler.importXML(editedXml);
        if (warnings.length) {
          console.log('import with warnings', warnings);
        } else {
          console.log('import successful');
        }
        const activeEditor = dmnModeler.getActiveViewer();
        const canvas = activeEditor.get('canvas');
        canvas.zoom('fit-viewport');
        $('#xml-editor').remove()
      } catch(err) {
        console.error('could not import XML', err);
      }

      $('#edit-button').text('XML');
      $('#edit-button').off('click');
      $('#edit-button').on('click', editXML);
      $('#save-button').text('Download DMN File');
      $('#save-button').off('click');
      $('#save-button').on('click', exportDiagram);
    });
  }

  /**
   * Save diagram contents to local download folder.
   */
  async function exportDiagram() {
    try {
      const { xml } = await dmnModeler.saveXML({ format: true });
      let blob = new Blob([xml], {type: 'text/plain'});
      let filename = 'diagram'
      let type = 'dmn'
      let input = prompt('Filename:', filename)
      if (input === null) {
        return
      } else {
        filename = input
      }
      let pom = document.createElement('a');
      pom.setAttribute('href', window.URL.createObjectURL(blob));
      pom.setAttribute('download', filename.concat('.dmn'));

      pom.dataset.downloadurl = ['text/plain', pom.download, pom.href].join(':');
      pom.draggable = true;
      pom.classList.add('dragout');

      pom.click();
      console.log('Diagram export');
    } catch (err) {
      console.error('could not save DMN 1.3 diagram', err);
    }
  }

  /**
   * Open diagram in our modeler instance.
   *
   * @param {String} dmnXML diagram to display
   */
  async function openDiagram(dmnXML) {

    // import diagram
    try {
      const { warnings } = await dmnModeler.importXML(dmnXML);

      if (warnings.length) {
        console.log('import with warnings', warnings);
      } else {
        console.log('import successful');
      }

      // access active editor components
      const activeEditor = dmnModeler.getActiveViewer();

      const canvas = activeEditor.get('canvas');

      // zoom to fit full viewport
      canvas.zoom('fit-viewport');

    } catch (err) {
      console.error('could not import DMN 1.3 diagram', err);
    }
  }

  async function openNewDiagram() {
    const fileInput = document.getElementById('newDmn');

    try {
      const file = fileInput.files[0];
      const reader = new FileReader();

      reader.readAsText(file);

      reader.onload = async (event) => {
        const xmlDmn = event.target.result;

        const { warnings } = await dmnModeler.importXML(xmlDmn);

        if (warnings.length) {
          console.log('import with warnings', warnings);
        } else {
          console.log('import successful');
        }

        const activeEditor = dmnModeler.getActiveViewer();
        const canvas = activeEditor.get('canvas');
        canvas.zoom('fit-viewport');
      };

    } catch (err) {
      console.error('could not read DMN file', err);
    }
  }


  // load external diagram file via AJAX and open it
  $.get(diagramUrl, openDiagram, 'text');

  // wire save button
  $('#save-button').click(exportDiagram);

  //wire edit button
  $('#edit-button').click(editXML);

  //wire dl-button
  $('#dl-button').click(openNewDiagram);
</script>
</body>
</html>